[CmdletBinding()]
Param(
    [Switch]$Uninstall

)


$ExportPath = "C:\Windows\System32\cve-2022-30190.reg"
$RegDrive = "HKCR"
$RegRootName = "HKEY_CLASSES_ROOT"
$RegKey = "ms-msdt"


if($Uninstall){
    reg import $ExportPath

    try{

        $PSDrive = New-PSDrive -PSProvider Registry -Root $RegRootName -Name $RegDrive -ErrorAction Stop

        if(Get-Item "${RegDrive}:\$RegKey"){
            Remove-PSDrive $PSDrive -Force
            Remove-Item $ExportPath -Force
            exit 0 # Successfully imported registry key
        }else{
            Remove-PSDrive $PSDrive -Force
            exit 1 # Failed to import registry key
        }
    }catch{
        exit 2 # Failed to create new psdrive for HKEY_CLASSES_ROOT to check registry key import
    }

}else{

    reg export "$RegRootName\$RegKey" $ExportPath

    if(Test-Path $ExportPath){
        reg delete "$RegRootName\$RegKey" /f

        try{

            $PSDrive = New-PSDrive -PSProvider Registry -Root $RegRootName -Name $RegDrive -ErrorAction Stop

            if(Get-Item "${RegDrive}:\$RegKey"){
                Remove-PSDrive $PSDrive -Force
                exit 3 # Failed to remove registry key
            }else{
                Remove-PSDrive $PSDrive -Force
                exit 0 # Success
            }
        }catch{
            exit 4 # Failed to create new psdrive for HKEY_CLASSES_ROOT to check registry key removal
        }
    }else{
        exit 5 # Failed to export registry
    }
}
